<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
      <meta name="robots" content="noai, noimageai">
    

    
      <title>Writing a JSON parser in BQN · Tony Zorman</title>
    

    <!-- Default appearance -->
    <link rel="stylesheet" type="text/css" href="../css/navbar.css">
    <link rel="stylesheet" type="text/css" href="../css/colours.css">
    <link rel="stylesheet" type="text/css" href="../css/fonts.css">
    <link rel="stylesheet" type="text/css" href="../css/default.css">
    <!-- Syntax highlighting -->
    <link rel="stylesheet" type="text/css" href="../css/pygments.css">
    <link rel="stylesheet" type="text/css" href="../css/katex.css">
    <!-- Margin and sidenotes -->
    <link rel="stylesheet" type="text/css" href="../css/sidenotes.css">
  </head>

  <body>
    <div class="navbar-space">
      <div id="navigation">
        <a href="../" class="menu-title">
          Tony's blog
        </a>
        <ul>
          <li><a href="../posts.html">Posts</a></li>
          <li><a href="../research.html">Research</a></li>
          <li><a href="../free-software.html">Free Software</a></li>
          <li><a href="../about.html">About</a></li>
        </ul>
      </div>
      <!-- A table of contents on the left side, but only for screens
           that are big enough -->
       
      <div id="contents-big">
        <p class="mini-header">Contents <a id="up-arrow" href="#">↑</a></p>
        <ul>
<li><a href="#lists-of-numbers">Lists of numbers</a>
<ul>
<li><a href="#tokenisation">Tokenisation</a></li>
<li><a href="#parsing">Parsing</a></li>
</ul></li>
<li><a href="#adding-strings">Adding strings</a>
<ul>
<li><a href="#parsing-1">Parsing</a></li>
<li><a href="#escaping">Escaping</a></li>
</ul></li>
<li><a href="#objects-and-their-ilk">Objects and their ilk</a>
<ul>
<li><a href="#parsing-2">Parsing</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
      </div>
       
    </div>
    <div class="text-space">
      <div id="content">
        <!-- We want to include the RSS/Atom feed in certain scenarios,
             but this shouldn't mangle the above header title. -->
         
        <h1>Writing a JSON parser in BQN</h1>
         

        <article>
    <p class="header">
      
        Posted on 2025-10-08
      
      
      
        &thinsp;·&thinsp; <span title="6562 words">27 min read</span> &thinsp;·&nbsp;
      
      
        <a title="All pages tagged 'BQN'." href="../tags/BQN.html" rel="tag">BQN</a>
      
    </p>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  <div id="contents">
    <p class="mini-header">Contents</p>
    <ul>
<li><a href="#lists-of-numbers">Lists of numbers</a>
<ul>
<li><a href="#tokenisation">Tokenisation</a></li>
<li><a href="#parsing">Parsing</a></li>
</ul></li>
<li><a href="#adding-strings">Adding strings</a>
<ul>
<li><a href="#parsing-1">Parsing</a></li>
<li><a href="#escaping">Escaping</a></li>
</ul></li>
<li><a href="#objects-and-their-ilk">Objects and their ilk</a>
<ul>
<li><a href="#parsing-2">Parsing</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
  </div>

<div>
  Let’s write a <span class="small-caps">json</span> parser in <span class="small-caps">bqn</span>!
<!--more-->
<p></p>
At least, for some vague definition of <span class="small-caps">json</span>.
I will restrict myself to the following underspecified subset,
so that this will not be a 20’000-word post:
<ul>
<li>Only (positive) integers.</li>
<li>ASCII only and only <code>\</code>-based escaping.</li>
<li>No constants.</li>
<li>Absolutely no input validation—we’ll try to parse the wildest things.</li>
</ul>
<p></p>
Some of those are not difficult to add:
adding negative integers is a 4-character change,
and other number formats are not much harder.
Constants are a fun exercise for the reader, and also useful for <span class="small-caps">json</span> in the wild.
Input validation is not difficult per se,
but seemed a bit too tedious for this blog post to me.
I’m staying away from Unicode though,
see <a href="https://github.com/mlochbaum/bqn-libs/blob/master/json.bqn">bqn-libs/json.bqn</a> for that.
In general, I do not claim originality for any line of code in this post<!--
-->—this is more or less my attempt to understand <a href="https://github.com/mlochbaum/bqn-libs/blob/master/json.bqn">bqn-libs/json.bqn</a> to a reasonable degree.
<p></p>
This article assumes that you are already a bit familiar with <span class="small-caps">bqn</span> as a language,
or know some amount of array programming and are willing to look up unknown symbols.
If not, I recommend starting with the official <a href="https://mlochbaum.github.io/BQN/tutorial/index.html">tutorials</a>.
I’ve also written about my experience of
<a href="https://tony-zorman.com/posts/aoc-in-bqn.html" class="local-link">using <span class="small-caps">bqn</span></a>
for Advent of Code,
a post which certainly contains some amount of written words that talk about the language.
I’ll recall the basic tricks that one uses in array-oriented parsing,
though if you feel like I’m going too fast perhaps it’s a good idea to peruse my post about writing a
<a href="https://tony-zorman.com/posts/bqn-csv.html" class="local-link"><span class="small-caps">csv</span> parser</a>.<!--
--><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><div class="sidenote">If you feel like I’m going too slow, or that I got something wrong, sorry!
As I said, this is more or less my way of learning and better understanding this style of parsing;
I am by no means the expert here.</div><!--
-->
<h2 id="lists-of-numbers">Lists of numbers<a href="#lists-of-numbers" class="floatleft sec-link">§</a></h2>
<p></p>
We’ll start with simply trying to parse lists of integers.
Can’t be that hard, right?
Additionally<!--
-->—and this is where <em>array-oriented</em> starts to come into play—<!--
-->we want to handle as much as possible using flat arrays.
This is both faster and way cooler.
In particular, this will result in a parser that has essentially no branching to speak of:
everything is just executed in order, line by line.
<p></p>
Motivated by an Advent of Code problem,
<a href="https://saltysylvi.github.io/blog/index.html">Sylvia</a>
has already written a
<a href="https://saltysylvi.github.io/blog/parsing-nested-lists-in-bqn.html">fantastic article</a>
about this exact type of thing,
including a comparison with two other approaches:
recursive descent, as well as a more nested array-style parser.<!--
--><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><div class="sidenote">Although <span class="small-caps">cbqn</span> seems to have improved since then<!--
  -->—for me, even the nested array version is faster than the recursive approach now.</div><!--
-->
I will follow the same approach for this part of the parser;
if you’ve already read—and understood—Sylvia’s post, feel free to skip to <a href="#adding-strings">Adding strings</a>.
<p></p>
Assume we have a list of numbers like the following:<!--
--><label for="sn-2" class="margin-toggle">⊕</label><input type="checkbox" id="sn-2" class="margin-toggle" /><div class="marginnote">󠀠
<p></p>
I will present many functions in a bottom-up kind of way,
where I gradually build them up in the <span class="small-caps">repl</span>,
using an example input to showcase the behaviour of the individual array manipulations.
Usually, proper definitions of <code>Tokenise</code> or <code>Parse</code> (the two functions we’re building)
will only be given at the very end of each section.
The input is always indented by four spaces, with the output flush to the left.
If I refer to an unknown variable further down, it was probably defined in such a block.</div><!--
-->
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s2">&quot;[12,34,5,678,910]&quot;</span>
<span class="s2">&quot;[12,34,5,678,910]&quot;</span>
</pre></div>

<p></p>
We’ll follow standard practise by first tokenising—lexing—the string,
and then parsing the tokens.
<h3 id="tokenisation">Tokenisation<a href="#tokenisation" class="floatleft sec-link">§</a></h3>
<p></p>
Brackets can stay as they are,
each number will be replaced by a single <code>0</code>,
and thus all commas can be removed.
We’ll then return a two element array,
the first entry containing the tokenised array,
and the second one being all of the numbers.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Tokenise</span><span class="w"> </span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[00000]&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">34</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">678</span><span class="w"> </span><span class="m">910</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
The first thing we have to do is to get the start of each number,
and save that in a variable <code>ns</code>,
while a mask of all numbers will be called <code>n</code>.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span>
<span class="s2">&quot;0123456789&quot;</span>
<span class="w">    </span><span class="nv">inp</span><span class="o">∊</span><span class="sr">(</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="sr">)</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">inp</span><span class="o">∊</span><span class="sr">(</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="sr">)</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ns</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">n</span><span class="kd">←</span><span class="nv">inp</span><span class="o">∊</span><span class="sr">(</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="sr">)</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">n</span><span class="w">         </span><span class="c1"># For comparison</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="o">≍</span><span class="w"> </span><span class="nv">ns</span><span class="w">  </span><span class="c1"># Visualise ns by stacking inp on top of it</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="w"> </span><span class="s1">'['</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span><span class="s1">'2'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'3'</span><span class="w"> </span><span class="s1">'4'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'5'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'6'</span><span class="w"> </span><span class="s1">'7'</span><span class="w"> </span><span class="s1">'8'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'9'</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span>
<span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w">                                                                     </span><span class="err">┘</span>
</pre></div>

<p></p>
While it’s not immediately obvious,
defining <code>ns</code> is useful because we can create a depth scan of all numbers,
where the start of each new number increases the depth by one.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">+</span><span class="na">`</span><span class="nv">ns</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="o">≍</span><span class="w"> </span><span class="o">+</span><span class="na">`</span><span class="nv">ns</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="w"> </span><span class="s1">'['</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span><span class="s1">'2'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'3'</span><span class="w"> </span><span class="s1">'4'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'5'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'6'</span><span class="w"> </span><span class="s1">'7'</span><span class="w"> </span><span class="s1">'8'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'9'</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span>
<span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span>
<span class="w">                                                                     </span><span class="err">┘</span>
</pre></div>

<p></p>
By supplementing this with <code>n</code>,
we obtain sufficient information to <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a> the string!
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">ns</span><span class="w">                                    </span><span class="c1"># Stencil out the numbers</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="w"> </span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">ns</span><span class="w">                                </span><span class="c1"># Kill irrelevant part</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="w"> </span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">ns</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">inp</span><span class="w">                          </span><span class="c1"># Grouping</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;12&quot;</span><span class="w"> </span><span class="s2">&quot;34&quot;</span><span class="w"> </span><span class="s2">&quot;5&quot;</span><span class="w"> </span><span class="s2">&quot;678&quot;</span><span class="w"> </span><span class="s2">&quot;910&quot;</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">•ParseFloat</span><span class="na">¨</span><span class="w"> </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="w"> </span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">ns</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">inp</span><span class="w">             </span><span class="c1"># Parsing</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">34</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">678</span><span class="w"> </span><span class="m">910</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="m">10</span><span class="py">⊸</span><span class="o">×</span><span class="py">⊸</span><span class="o">+</span><span class="na">˜´</span><span class="py">∘</span><span class="o">⌽-</span><span class="py">⟜</span><span class="s1">'0'</span><span class="sr">)</span><span class="na">¨</span><span class="w"> </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="w"> </span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">ns</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">inp</span><span class="w">       </span><span class="c1"># Or: manual parsing</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">34</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">678</span><span class="w"> </span><span class="m">910</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Now all that’s left in the tokenisation step
is to create the string <code>"[00000]"</code> from the input.
Since we know all other tokens,
this can be achieved with a combination of <a href="https://mlochbaum.github.io/BQN/doc/replicate.html">replicate</a> and <a href="https://mlochbaum.github.io/BQN/doc/replicate.html">indices</a>,
as well as <a href="https://mlochbaum.github.io/BQN/doc/under.html">under</a> and <a href="https://mlochbaum.github.io/BQN/doc/select.html">select</a>:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">ns</span><span class="w"> </span><span class="o">∨</span><span class="w"> </span><span class="nv">inp</span><span class="o">∊</span><span class="s2">&quot;[]&quot;</span><span class="w">                </span><span class="c1"># Tokens are numbers and brackets</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="o">/</span><span class="nv">inp</span><span class="w">                            </span><span class="c1"># Just the tokens of the string</span>
<span class="s2">&quot;[13569]&quot;</span>
<span class="w">    </span><span class="o">/</span><span class="nv">ns</span><span class="w">                               </span><span class="c1"># Indices of 1's (= number beginnings)</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="o">/</span><span class="nv">ns</span><span class="sr">)</span><span class="py">⊸</span><span class="o">⊏</span><span class="sr">)</span><span class="nv">inp</span><span class="w">                 </span><span class="c1"># Make them zero</span>
<span class="s2">&quot;[02,04,0,078,010]&quot;</span>
<span class="w">    </span><span class="nv">ts</span><span class="o">/</span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="o">/</span><span class="nv">ns</span><span class="sr">)</span><span class="py">⊸</span><span class="o">⊏</span><span class="sr">)</span><span class="nv">inp</span><span class="w">              </span><span class="c1"># Choose just the tokens</span>
<span class="s2">&quot;[00000]&quot;</span>
</pre></div>

<p></p>
That’ll do!
We can put all of this into a function now:<!--
--><label for="sn-3" class="margin-toggle">⊕</label><input type="checkbox" id="sn-3" class="margin-toggle" /><div class="marginnote">󠀠
<p></p>
We could in fact also move <a href="https://mlochbaum.github.io/BQN/doc/replicate.html">replicate</a>
into the calls to <code>ns</code> and <code>𝕩</code> and then replace <a href="https://mlochbaum.github.io/BQN/doc/select.html">select</a> with another <a href="https://mlochbaum.github.io/BQN/doc/replicate.html">replicate</a>:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="nv">ts</span><span class="o">/</span><span class="nv">ns</span><span class="sr">)</span><span class="py">⊸</span><span class="o">/</span><span class="sr">)</span><span class="w"> </span><span class="sr">(</span><span class="nv">ts</span><span class="o">/</span><span class="nv">inp</span><span class="sr">)</span>
<span class="s2">&quot;[0,0,0,0,0]&quot;</span>
</pre></div>

<p></p>
I’m not super well-versed in the ins and outs of <span class="small-caps">cbqn</span>’s performance,
but from a cursory benchmark with the <code>•_timed</code> modifier,
it does not seem to make much of a difference.</div><!--
-->
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="o">Tokenise</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">ns</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">n</span><span class="kd">←</span><span class="ni">𝕩</span><span class="o">∊</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="w">           </span><span class="c1"># Number beginnings</span>
<span class="w">  </span><span class="nv">nr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">•ParseFloat</span><span class="na">¨</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">ns</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w"> </span><span class="c1"># Numbers to return</span>
<span class="w">  </span><span class="nv">ts</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">ns</span><span class="o">∨</span><span class="ni">𝕩</span><span class="o">∊</span><span class="s2">&quot;[]&quot;</span><span class="w">                 </span><span class="c1"># Tokens</span>
<span class="w">  </span><span class="p">⟨</span><span class="nv">ts</span><span class="o">/</span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="o">/</span><span class="nv">ns</span><span class="sr">)</span><span class="py">⊸</span><span class="o">⊏</span><span class="sr">)</span><span class="ni">𝕩</span><span class="p">,</span><span class="w"> </span><span class="nv">nr</span><span class="p">⟩</span>
<span class="kt">}</span>
</pre></div>

<p></p>
This of course also works with nested lists,
giving us a flat representation in <code>nr</code>:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Tokenise</span><span class="w"> </span><span class="s2">&quot;[1,[2,[3],4],[5,6]]&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[0[0[0]0][00]]&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Using the “blueprint” <code>"[0[0[0]0][00]]"</code>,
the main job of the parser will be to turn the flat representation of <code>nr</code> back into a nested list
<h3 id="parsing">Parsing<a href="#parsing" class="floatleft sec-link">§</a></h3>
<p></p>
The end result we want looks like this:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Parse</span><span class="w"> </span><span class="s2">&quot;[1,[2,[3]],4]&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
For this post, let’s define a function to compactly display some text,
so that I can use some more complicated arguments without <a href="https://mlochbaum.github.io/BQN/doc/couple.html">couple</a> taking up too much space.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">DP</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span><span class="w"> </span><span class="ni">𝕨</span><span class="o">≍</span><span class="s1">'0'</span><span class="o">+</span><span class="ni">𝕩</span><span class="w"> </span><span class="kt">}</span>
<span class="sr">(</span><span class="nv">function</span><span class="w"> </span><span class="nv">block</span><span class="sr">)</span>
<span class="w">    </span><span class="s2">&quot;abc&quot;</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="p">⟨</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">⟩</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;abc</span>
<span class="s2">  123&quot;</span>
<span class="w">      </span><span class="err">┘</span>
</pre></div>

<p></p>
The first thing we need to do is to get a depth ordering of the list;
i.e., make an opening bracket increase and have a closing one decrease the depth by one.<!--
--><label for="sn-4" class="margin-toggle">⊕</label><input type="checkbox" id="sn-4" class="margin-toggle" /><div class="marginnote">󠀠
<p></p>
󠀠
<p></p>
󠀠
<p></p>
󠀠
<p></p>
󠀠
<p></p>
󠀠
<p></p>
As you can see, an opening parenthesis is treated as being inside of the pair,
while a closing one is outside.
This is fine (even wanted) for this use-case;
if you want to treat both pairs as being inside of the pair you can use
<code>+`o-»c</code>.</div><!--
-->
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">inp</span><span class="kd">←</span><span class="s2">&quot;[1,[2,[3,4]],5,[6,7],8]&quot;</span>
<span class="s2">&quot;[1,[2,[3,4]],5,[6,7],8]&quot;</span>
<span class="w">    </span><span class="nv">ts</span><span class="p">‿</span><span class="nv">nums</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">Tokenise</span><span class="w"> </span><span class="nv">inp</span><span class="w"> </span><span class="c1"># Tokens and numbers</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[0[0[00]]0[00]0]&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">o</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">'['</span><span class="o">=</span><span class="nv">ts</span><span class="w">             </span><span class="c1"># Opening brackets</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">c</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">']'</span><span class="o">=</span><span class="nv">ts</span><span class="w">             </span><span class="c1"># Closing brackets</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="o">+</span><span class="na">`</span><span class="nv">o</span><span class="o">-</span><span class="nv">c</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[0[0[00]]0[00]0]</span>
<span class="s2">  1122333211222110&quot;</span>
<span class="w">                   </span><span class="err">┘</span>
</pre></div>

<p></p>
We can obtain a depth ordering of the list by turning <code>+`o-c</code> into a permutation with <a href="https://mlochbaum.github.io/BQN/doc/order.html">grade up</a>
and then indexing into the tokens with <a href="https://mlochbaum.github.io/BQN/doc/select.html">select</a>.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">d</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋+</span><span class="na">`</span><span class="nv">o</span><span class="o">-</span><span class="nv">c</span><span class="w"> </span><span class="c1"># Depth ordering</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">d</span><span class="o">⊏</span><span class="nv">ts</span>
<span class="s2">&quot;][0]0]0[0][00[00&quot;</span>
</pre></div>

<p></p>
This is pretty hard to read at first (and even later),
but it’s really nothing more than a breadth-first ordering of the input.
Since <code>inp</code> is defined as <code>"[1,[2,[3,4]],5,[6,7],8]"</code>
and so in particular only contains one-digit numbers,
it’s perhaps more instructive to look at
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">d</span><span class="o">⊏</span><span class="sr">(</span><span class="o">¬</span><span class="s1">','</span><span class="py">⊸</span><span class="o">=</span><span class="sr">)</span><span class="py">⊸</span><span class="o">/</span><span class="nv">inp</span>
<span class="s2">&quot;][1]5]8[2][67[34&quot;</span>
</pre></div>

<p></p>
Drawing a picture often helps:
<p></p>
<img src="../images/tikz/3085976404374306490.svg" class="tikzpicture" />
<p></p>
So <code>]</code> indicates that a new sublist be placed at a certain slot,
and <code>[</code> is the start of such a sublist.
Filling in the tree from the string proceeds from left to right,
and every time we encounter a <code>[</code> we look for the “oldest” <code>]</code> that still isn’t filled, and start there.
<p></p>
We now assign each sublist the depth in this tree representation.
This works much like the <code>+`o-c</code> trick above,
only we don’t need to care about closing parentheses<!--
-->—they only show up when we are going a level deeper anyways.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="s1">'['</span><span class="o">=</span><span class="nv">d</span><span class="o">⊏</span><span class="nv">ts</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">l</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="s1">'['</span><span class="o">=</span><span class="nv">d</span><span class="o">⊏</span><span class="nv">ts</span><span class="w">             </span><span class="c1"># Nesting</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">l</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[0[0[00]]0[00]0]</span>
<span class="s2">  1122444211333110&quot;</span>
<span class="w">                   </span><span class="err">┘</span>
</pre></div>

<p></p>
Compare this with the above tree.
One important detail is that we index with <code>⍋d</code> and not just <code>d</code>:
since <code>d</code> is a permutation already, we can invert it with another call to <a href="https://mlochbaum.github.io/BQN/doc/order.html">grade up</a>.
This effectively allows us to translate back from the BFS ordering of <code>d⊏ts</code>,
into the “ordinary” ordering that we started with.
<p></p>
This is a lot to take in;
I would encourage you to play with these ideas for a while, until you’re comfortable with them.
<hr />
<p></p>
Now that we know in which order to fill the sublists,
it’s about time that we figure out which values to use for that very filling.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">ln</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">ts</span><span class="o">∊</span><span class="s2">&quot;0]&quot;</span><span class="w">                 </span><span class="c1"># Literals and nesting</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">ln</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[0[0[00]]0[00]0]</span>
<span class="s2">  0101011111011111&quot;</span>
<span class="w">                   </span><span class="err">┘</span>
<span class="w">    </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'0'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">c</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">vi</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋⍋</span><span class="w"> </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'0'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">c</span><span class="w"> </span><span class="c1"># Value indices</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="sr">)</span><span class="w"> </span><span class="o">≍</span><span class="w"> </span><span class="nv">vi</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span>
<span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">8</span><span class="w">   </span><span class="m">9</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">6</span><span class="w">   </span><span class="m">10</span><span class="w">  </span><span class="m">7</span><span class="w">   </span><span class="m">11</span>
<span class="w">                                                  </span><span class="err">┘</span>
<span class="w">    </span><span class="nv">inp</span>
<span class="s2">&quot;[1,[2,[3,4]],5,[6,7],8]&quot;</span>
</pre></div>

<p></p>
We separate out the literals,
as well as the “nesting indicator” <code>]</code>,
and then produce a list of “value indices”
that should indicate the order in which the final output is to be filled.
We use the
<a href="https://mlochbaum.github.io/BQN/doc/order.html#ordinals">ordinals pattern</a>
<code>⍋⍋</code> to turn <code>ln</code> into something we can actually use to index into <code>ts</code>.
However, there is a problem:
the filling of the actual literals will be from left to right,
so the order is fine already,
but the closing brackets are all over the place.
For example, the second <code>]</code>, assigned to index <code>9</code>, is associated to the sublist <code>[6,7]</code> in the original input.
Since we will construct the final list bottom-up,
this should come after the list <code>[2,[3,4]]</code>,
the closing bracket of which is however assigned to index <code>10</code>.
<p></p>
To fix this, we use the nesting variable <code>l</code> defined above<!--
-->—there, we’ve already associated a sublist to its depth in the breadth-first representation.
Looking at <code>l</code> again, we can find the index of the sublist that a given <code>]</code> is closing by looking at the index of the element in front of it:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">l</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[0[0[00]]0[00]0]</span>
<span class="s2">  1122444211333110&quot;</span>
<span class="w">                   </span><span class="err">┘</span>
<span class="w">    </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Since the list with the highest index above will be constructed first,
we have to invert these numbers.
Then, we just have to add these to the rest of the literals.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span><span class="w">          </span><span class="c1"># Deeply nested lists are constructed *first*</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="o">≠</span><span class="nv">nums</span><span class="sr">)</span><span class="o">+</span><span class="w"> </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span><span class="w"> </span><span class="c1"># Indices should not clash with literals</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="o">↕≠</span><span class="nv">nums</span><span class="sr">)</span><span class="o">∾</span><span class="w"> </span><span class="sr">(</span><span class="o">≠</span><span class="nv">nums</span><span class="sr">)</span><span class="o">+</span><span class="w"> </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span><span class="w"> </span><span class="c1"># Add to end</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">vi</span><span class="w"> </span><span class="kd">↩</span><span class="w"> </span><span class="nv">vi</span><span class="o">⊏</span><span class="sr">(</span><span class="o">↕≠</span><span class="nv">nums</span><span class="sr">)</span><span class="o">∾</span><span class="w"> </span><span class="sr">(</span><span class="o">≠</span><span class="nv">nums</span><span class="sr">)</span><span class="o">+</span><span class="w"> </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span><span class="w"> </span><span class="c1"># Fix vi by indexing this new list</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
This gives us fixed indices:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="sr">)</span><span class="w"> </span><span class="o">≍</span><span class="w"> </span><span class="nv">vi</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="s1">'0'</span><span class="w"> </span><span class="s1">']'</span>
<span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">8</span><span class="w">   </span><span class="m">10</span><span class="w">  </span><span class="m">4</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">6</span><span class="w">   </span><span class="m">9</span><span class="w">   </span><span class="m">7</span><span class="w">   </span><span class="m">11</span>
<span class="w">                                                  </span><span class="err">┘</span>
</pre></div>

<p></p>
This means we first construct <code>[3,4]</code>, then <code>[2,[3,4]]</code>, then <code>[6,7]</code>, and finally the whole list <code>[1,[2,[3,4]],5,[6,7],8]</code>.
For this, we simply have to <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a> the indices of <code>vi</code> accordingly.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">vi</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="w"> </span><span class="c1"># Since vi also only contains indices for literals and nesting</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="w"> </span><span class="c1"># Drop final ] for the whole list</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">⌽</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span><span class="w"> </span><span class="c1"># Reverse to build deeply nested lists sooner</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Now all that is left is to build the whole list recursively.
We start with the list of literals,
construct the next list, and add it to the end of the list of literals.
This way, the later indices <code>8</code>, <code>9</code>, and <code>10</code> will refer to these sublists.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">⌽</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">nums</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="m">2</span><span class="p">‿</span><span class="m">3</span><span class="o">⊏</span><span class="nv">nums</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">nums</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="m">2</span><span class="p">‿</span><span class="m">3</span><span class="o">⊏</span><span class="nv">nums</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">nums</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="m">5</span><span class="p">‿</span><span class="m">6</span><span class="o">⊏</span><span class="nv">nums</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">nums</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="m">1</span><span class="p">‿</span><span class="m">8</span><span class="o">⊏</span><span class="nv">nums</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">                                                </span><span class="err">┘</span>
<span class="w">    </span><span class="nv">nums</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="m">0</span><span class="p">‿</span><span class="m">10</span><span class="p">‿</span><span class="m">4</span><span class="p">‿</span><span class="m">9</span><span class="p">‿</span><span class="m">7</span><span class="o">⊏</span><span class="nv">nums</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="err">┌─</span>
<span class="w">                                                </span><span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">8</span>
<span class="w">                                                                              </span><span class="err">┘</span>
<span class="w">                                                                                </span><span class="err">┘</span>
<span class="w">    </span><span class="m">¯1</span><span class="o">⊑</span><span class="nv">nums</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">8</span>
<span class="w">                              </span><span class="err">┘</span>
</pre></div>

<p></p>
More concisely:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">res</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">nums</span><span class="w"> </span><span class="c1"># Mutation is evil</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="kt">{</span><span class="nv">res</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="ni">𝕩</span><span class="o">⊏</span><span class="nv">res</span><span class="w"> </span><span class="p">⋄</span><span class="ss">@</span><span class="kt">}</span><span class="na">¨</span><span class="w"> </span><span class="o">⌽</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span>
<span class="s2">&quot;    &quot;</span>
<span class="w">    </span><span class="m">¯1</span><span class="o">⊑</span><span class="nv">res</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">8</span>
<span class="w">                              </span><span class="err">┘</span>
</pre></div>

<p></p>
One tiny change has to be made to the building of the sublists:
if our input is <code>"[]"</code>, then <code>1-˜ln/l</code> will be <code>⟨¯1⟩</code>,
to the list as a whole will be dropped!
We can hackily fix this by always appending the total number of closing brackets to the back of the list via <code>(+´c)∾˜</code>.
If the list is empty, then this will accommodate for that case.
Otherwise, the left argument to <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a> will be one element longer than the right one.
This is not a problem, however, because that’s actually a feature<!--
--><label for="sn-5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-5" class="margin-toggle" /><div class="sidenote">A questionable <span class="small-caps">api</span> choice, for sure, but I’ll take it!</div><!--
--> of the function:
in that case, the last element specified the minimum length of the result.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="m">0</span><span class="p">‿</span><span class="m">¯1</span><span class="p">‿</span><span class="m">1</span><span class="p">‿</span><span class="m">4</span><span class="w"> </span><span class="o">⊔</span><span class="w"> </span><span class="s2">&quot;abc&quot;</span><span class="w"> </span><span class="c1"># Padding</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;c&quot;</span><span class="w"> </span><span class="p">⟨⟩</span><span class="w"> </span><span class="p">⟨⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Putting everything together:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="o">Parse</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">ts</span><span class="p">‿</span><span class="nv">nums</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">Tokenise</span><span class="w"> </span><span class="ni">𝕩</span><span class="w">                 </span><span class="c1"># Tokens and numbers</span>
<span class="w">  </span><span class="nv">o</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">'['</span><span class="o">=</span><span class="nv">ts</span><span class="w">                           </span><span class="c1"># Opening brackets</span>
<span class="w">  </span><span class="nv">c</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">']'</span><span class="o">=</span><span class="nv">ts</span><span class="w">                           </span><span class="c1"># Closing brackets</span>
<span class="w">  </span><span class="nv">d</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋+</span><span class="na">`</span><span class="nv">o</span><span class="o">-</span><span class="nv">c</span><span class="w">                           </span><span class="c1"># Depth ordering</span>
<span class="w">  </span><span class="nv">ln</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">ts</span><span class="o">∊</span><span class="s2">&quot;0]&quot;</span><span class="w">                         </span><span class="c1"># Literals and nesting</span>
<span class="w">  </span><span class="nv">l</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="s1">'['</span><span class="o">=</span><span class="nv">d</span><span class="o">⊏</span><span class="nv">ts</span><span class="w">                  </span><span class="c1"># Sublist depth</span>
<span class="w">  </span><span class="nv">vi</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋⍋</span><span class="w"> </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'0'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">c</span><span class="w">         </span><span class="c1"># Value indices</span>
<span class="w">  </span><span class="nv">r</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">nums</span><span class="w">                             </span><span class="c1"># Result</span>
<span class="w">  </span><span class="nv">vi</span><span class="w"> </span><span class="o">⊏</span><span class="kd">↩</span><span class="w"> </span><span class="sr">(</span><span class="o">↕≠</span><span class="nv">nums</span><span class="sr">)</span><span class="o">∾</span><span class="sr">(</span><span class="o">≠</span><span class="nv">nums</span><span class="sr">)</span><span class="o">+</span><span class="w"> </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span><span class="w">     </span><span class="c1"># Fix value indices</span>
<span class="w">  </span><span class="kt">{</span><span class="nv">r</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="ni">𝕩</span><span class="o">⊏</span><span class="nv">r</span><span class="w"> </span><span class="p">⋄</span><span class="ss">@</span><span class="kt">}</span><span class="na">¨</span><span class="w"> </span><span class="o">⌽</span><span class="sr">((</span><span class="o">+</span><span class="na">´</span><span class="nv">c</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span><span class="w"> </span><span class="c1"># Build result</span>
<span class="w">  </span><span class="m">¯1</span><span class="o">⊑</span><span class="nv">r</span>
<span class="kt">}</span>
</pre></div>

<p></p>
Works like a charm:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Parse</span><span class="w"> </span><span class="s2">&quot;[1,[2,[3,4]],5,[6,7],8]&quot;</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">8</span>
<span class="w">                              </span><span class="err">┘</span>
<span class="w">    </span><span class="o">Parse</span><span class="w"> </span><span class="s2">&quot;[]&quot;</span>
<span class="p">⟨⟩</span>
<span class="w">    </span><span class="o">Parse</span><span class="w"> </span><span class="s2">&quot;[1, [42, [[0], 2, 3]], 30]&quot;</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="err">┌─</span><span class="w">                   </span><span class="m">30</span>
<span class="w">    </span><span class="m">·</span><span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">                       </span><span class="err">┘</span>
<span class="w">                            </span><span class="err">┘</span>
<span class="w">    </span><span class="o">Parse</span><span class="w"> </span><span class="s2">&quot;[1,2,[],[3,4,[5,6]],7,8,[9,[],10]]&quot;</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="p">⟨⟩</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">                                         </span><span class="err">┘</span>
</pre></div>

<h2 id="adding-strings">Adding strings<a href="#adding-strings" class="floatleft sec-link">§</a></h2>
<p></p>
I’d like to add one more literal,
so that we get a feeling for how to do that sort of extension;
strings sound like a good idea.
<p></p>
First, the lexer: getting the strings and their beginnings works almost the same as in the numbers case above.<!--
--><label for="sn-6" class="margin-toggle">⊕</label><input type="checkbox" id="sn-6" class="margin-toggle" /><div class="marginnote">The double quotes <code>""</code> in the string are <span class="small-caps">bqn</span>’s way of escaping quotes
(the same way that <span class="small-caps">csv</span> does it).
<em>Everything</em> else is treated as a literal characters, even backslashes!</div><!--
-->
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s2">&quot;[1,&quot;&quot;a&quot;&quot;,2,&quot;&quot;b&quot;&quot;]&quot;</span>
<span class="s2">&quot;[1,&quot;&quot;a&quot;&quot;,2,&quot;&quot;b&quot;&quot;]&quot;</span>
<span class="w">    </span><span class="nv">s</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">≠</span><span class="na">`</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">inp</span><span class="w">             </span><span class="c1"># strings</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Before we move on, let’s slightly change the definition of <code>DP</code>:
for syntax highlighting reasons, I’d like quotes to occupy a single character that is not the quote character itself.
Let’s just substitute <code>'</code> for <code>"</code> in the left argument,
which should fix this issue and hopefully still be clear enough.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">DP</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span><span class="sr">((</span><span class="ss">@</span><span class="o">+</span><span class="m">39</span><span class="sr">)</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="ni">𝕨</span><span class="o">=</span><span class="s1">'&quot;'</span><span class="sr">)</span><span class="py">⊸</span><span class="o">/</span><span class="sr">)</span><span class="ni">𝕨</span><span class="sr">)</span><span class="w"> </span><span class="o">≍</span><span class="w"> </span><span class="s1">'0'</span><span class="o">+</span><span class="ni">𝕩</span><span class="kt">}</span>
<span class="sr">(</span><span class="nv">function</span><span class="w"> </span><span class="nv">block</span><span class="sr">)</span>
<span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">s</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[1,'a',2,'b']</span>
<span class="s2">  0001100001100&quot;</span>
<span class="w">                </span><span class="err">┘</span>
<span class="w">    </span><span class="nv">sb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">s</span><span class="w">                </span><span class="c1"># string beginnings</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">sb</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[1,'a',2,'b']</span>
<span class="s2">  0001000001000&quot;</span>
<span class="w">                </span><span class="err">┘</span>
</pre></div>

<p></p>
Selecting the strings also works the same way;
do a sum <a href="https://mlochbaum.github.io/BQN/doc/scan.html">scan</a> on the string beginnings, punch out the actual strings, and then <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a>.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">s</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">+</span><span class="na">`</span><span class="nv">sb</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">s</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="m">¯1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">s</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;&quot;&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="m">1</span><span class="o">↓</span><span class="na">¨</span><span class="w"> </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">s</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Actually, you can be a little bit smarter here;
instead of dropping the first element of every string,
we can instead make sure that they are never selected by <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a>
by comparing when <code>s</code> is bigger than <code>sb</code>:
this will only be the case if one is truly inside of a string.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="sr">(</span><span class="nv">s</span><span class="o">&gt;</span><span class="nv">sb</span><span class="sr">)</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="w">               </span><span class="c1"># Same as (s∧¬sb)×+`sb</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="sr">(</span><span class="nv">s</span><span class="o">&gt;</span><span class="nv">sb</span><span class="sr">)</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Putting this together in our tokeniser,
we now also need to make sure that we ignore everything that’s happening inside of a string.
To do that, we can introduce an “exclusion” variable
<code>ex ← s∨𝕩∊@+9‿10‿13‿32</code>
and thread it through to the respective definitions.<!--
--><label for="sn-7" class="margin-toggle">⊕</label><input type="checkbox" id="sn-7" class="margin-toggle" /><div class="marginnote">󠀠
<p></p>
You will see repeated definitions of <code>Tokenise</code> and <code>Parse</code> throughout this article.
I figured that perhaps indicating changes in this way is more readable than giving you diffs,
if only because all context one needs is right there.
That’s one of the advantages of the complete program fitting on a single screen!</div><!--
-->
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="o">Tokenise</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">sb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">s</span><span class="kd">←</span><span class="o">≠</span><span class="na">`</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="ni">𝕩</span><span class="w">             </span><span class="c1"># String beginnings</span>
<span class="w">  </span><span class="nv">sr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="sr">(</span><span class="nv">s</span><span class="o">&gt;</span><span class="nv">sb</span><span class="sr">)</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w">        </span><span class="c1"># Strings to return</span>

<span class="w">  </span><span class="nv">ex</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">s</span><span class="o">∨</span><span class="ni">𝕩</span><span class="o">∊</span><span class="ss">@</span><span class="o">+</span><span class="m">9</span><span class="p">‿</span><span class="m">10</span><span class="p">‿</span><span class="m">13</span><span class="p">‿</span><span class="m">32</span><span class="w">          </span><span class="c1"># Exclude whitespace and strings</span>
<span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">n</span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="w"> </span><span class="ni">𝕩</span><span class="o">∊</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="w">   </span><span class="c1"># Number beginnings</span>
<span class="c1">#             ^^^^^^</span>
<span class="w">  </span><span class="nv">nr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">•ParseFloat</span><span class="na">¨</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">nb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w"> </span><span class="c1"># Numbers to return</span>

<span class="w">  </span><span class="nv">ts</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">sb</span><span class="o">∨</span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="nv">nb</span><span class="o">∨</span><span class="ni">𝕩</span><span class="o">∊</span><span class="s2">&quot;[]&quot;</span><span class="w">        </span><span class="c1"># Tokens</span>
<span class="c1">#         ^^^^^^</span>
<span class="w">  </span><span class="p">⟨</span><span class="nv">ts</span><span class="o">/</span><span class="w"> </span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="o">/</span><span class="nv">nb</span><span class="sr">)</span><span class="py">⊸</span><span class="o">⊏</span><span class="sr">)</span><span class="w"> </span><span class="ni">𝕩</span><span class="p">,</span><span class="w"> </span><span class="nv">nr</span><span class="p">,</span><span class="w"> </span><span class="nv">sr</span><span class="p">⟩</span>
<span class="kt">}</span>
</pre></div>

<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Tokenise</span><span class="w"> </span><span class="s2">&quot;[1,&quot;&quot;a&quot;&quot;,2,&quot;&quot;b&quot;&quot;]&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[0&quot;&quot;0&quot;&quot;]&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">Tokenise</span><span class="w"> </span><span class="s2">&quot;[1,&quot;&quot;a,2,b&quot;&quot;]&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[0&quot;&quot;]&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a,2,b&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<h3 id="parsing-1">Parsing<a href="#parsing-1" class="floatleft sec-link">§</a></h3>
<p></p>
Adjusting the parser is actually quite easy here:
we just have to add quotes to the allowed literals,
make the value indices aware of them,
and also feed them into the initial value of the result;
no further changes necessary.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="o">Parse</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">ts</span><span class="p">‿</span><span class="nv">nums</span><span class="p">‿</span><span class="nv">strs</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">Tokenise</span><span class="w"> </span><span class="ni">𝕩</span><span class="w">                    </span><span class="c1"># Tokens, numbers, and strings</span>
<span class="c1">#        ^^^^^</span>
<span class="w">  </span><span class="nv">o</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">'['</span><span class="o">=</span><span class="nv">ts</span><span class="w">                                   </span><span class="c1"># Opening, closing, depth</span>
<span class="w">  </span><span class="nv">c</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">']'</span><span class="o">=</span><span class="nv">ts</span><span class="w">                                   </span><span class="c1"># Closing brackets</span>
<span class="w">  </span><span class="nv">d</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋+</span><span class="na">`</span><span class="nv">o</span><span class="o">-</span><span class="nv">c</span><span class="w">                                   </span><span class="c1"># Depth ordering</span>
<span class="w">  </span><span class="nv">ln</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">ts</span><span class="o">∊</span><span class="s2">&quot;&quot;&quot;0]&quot;</span><span class="w">                               </span><span class="c1"># Literals and nesting</span>
<span class="c1">#          ^^</span>
<span class="w">  </span><span class="nv">l</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="s1">'['</span><span class="o">=</span><span class="nv">d</span><span class="o">⊏</span><span class="nv">ts</span><span class="w">                          </span><span class="c1"># Sublist depth</span>
<span class="w">  </span><span class="nv">vi</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋⍋</span><span class="w"> </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'0'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sr">(</span><span class="m">2</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'&quot;'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">c</span><span class="w"> </span><span class="c1"># Value indices</span>
<span class="c1">#                       ^^^^^^^^^^^^^</span>
<span class="w">  </span><span class="nv">r</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">nums</span><span class="o">∾</span><span class="nv">strs</span><span class="w">                                </span><span class="c1"># Result</span>
<span class="c1">#         ^^^^^</span>
<span class="w">  </span><span class="nv">vi</span><span class="w"> </span><span class="o">⊏</span><span class="kd">↩</span><span class="w"> </span><span class="sr">(</span><span class="o">↕≠</span><span class="nv">r</span><span class="sr">)</span><span class="o">∾</span><span class="sr">(</span><span class="o">≠</span><span class="nv">r</span><span class="sr">)</span><span class="o">+</span><span class="w"> </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">l</span><span class="w">                   </span><span class="c1"># Fix value indices</span>
<span class="w">  </span><span class="kt">{</span><span class="nv">r</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="ni">𝕩</span><span class="o">⊏</span><span class="nv">r</span><span class="w"> </span><span class="p">⋄</span><span class="ss">@</span><span class="kt">}</span><span class="na">¨</span><span class="w"> </span><span class="o">⌽</span><span class="sr">((</span><span class="o">+</span><span class="na">´</span><span class="nv">c</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span><span class="w">         </span><span class="c1"># Build result</span>
<span class="w">  </span><span class="m">¯1</span><span class="o">⊑</span><span class="nv">r</span>
<span class="kt">}</span>
</pre></div>

<h3 id="escaping">Escaping<a href="#escaping" class="floatleft sec-link">§</a></h3>
<p></p>
To make things a little bit—though not too—interesting, let’s add some easy escaping.
By this I exclusively mean backslash-based escaping:
every time we encounter a backslash inside of a string,
we treat the following character (e.g., a quote) literally.
Thinking about semantics a bit, if we have a sequence of backslashes like <code>\\\\\</code>,
we want to alternate between treating them as the escapist and the escapee.
One way to do this is with a less-than <a href="https://mlochbaum.github.io/BQN/doc/scan.html">scan</a>:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s2">&quot;[1,&quot;&quot;a&quot;&quot;,&quot;&quot;b_\\\&quot;&quot;\\_c&quot;&quot;]&quot;</span>
<span class="s2">&quot;[1,&quot;&quot;a&quot;&quot;,&quot;&quot;b_\\\&quot;&quot;\\_c&quot;&quot;]&quot;</span>
<span class="w">    </span><span class="s1">'\'</span><span class="o">=</span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">&lt;</span><span class="na">`</span><span class="s1">'\'</span><span class="o">=</span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="o">&lt;</span><span class="na">`</span><span class="s1">'\'</span><span class="o">=</span><span class="nv">inp</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[1,'a','b_\\\'\\_c']</span>
<span class="s2">  00000000001010100000&quot;</span>
<span class="w">                       </span><span class="err">┘</span>
</pre></div>

<p></p>
We effectively check if the previous character of the string was escaped, but in a left-to-right fashion
(as in, earlier choices on the left affect those on the right).
To get the escaped values themselves, we can now simply <a href="https://mlochbaum.github.io/BQN/doc/shift.html">nudge</a> the string to the right.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="o">»&lt;</span><span class="na">`</span><span class="s1">'\'</span><span class="o">=</span><span class="nv">inp</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;[1,'a','b_\\\'\\_c']</span>
<span class="s2">  00000000000101010000&quot;</span>
<span class="w">                       </span><span class="err">┘</span>
</pre></div>

<p></p>
Finally, when selecting the strings, we just need to exclude the escaped quotes:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">e</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»&lt;</span><span class="na">`</span><span class="s1">'\'</span><span class="o">=</span><span class="nv">inp</span><span class="w">     </span><span class="c1"># Escapes</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">s</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">≠</span><span class="na">`</span><span class="sr">(</span><span class="o">¬</span><span class="nv">e</span><span class="sr">)</span><span class="o">∧</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">inp</span><span class="w"> </span><span class="c1"># Strings are in quotes that are not escaped</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">sb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">s</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="sr">(</span><span class="nv">s</span><span class="o">&gt;</span><span class="nv">sb</span><span class="sr">)</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b_\\\&quot;&quot;\\_c&quot;</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
As we are dealing with Boolean masks,
alternatively to <code>(¬e)∧'"'=inp</code> one could also write the shorter,
though slightly more obscure,
<code>e&lt;'"'=inp</code>.
All in all, we have
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="o">Tokenise</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">e</span><span class="w">  </span><span class="kd">←</span><span class="w"> </span><span class="o">»&lt;</span><span class="na">`</span><span class="s1">'\'</span><span class="o">=</span><span class="ni">𝕩</span><span class="w">                  </span><span class="c1"># Escapes</span>
<span class="w">  </span><span class="nv">sb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">s</span><span class="kd">←</span><span class="w"> </span><span class="o">≠</span><span class="na">`</span><span class="sr">(</span><span class="o">¬</span><span class="nv">e</span><span class="sr">)</span><span class="o">∧</span><span class="w"> </span><span class="s1">'&quot;'</span><span class="o">=</span><span class="ni">𝕩</span><span class="w">      </span><span class="c1"># String beginnings</span>
<span class="w">  </span><span class="nv">sr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="sr">(</span><span class="nv">s</span><span class="o">&gt;</span><span class="nv">sb</span><span class="sr">)</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w">        </span><span class="c1"># Strings to return</span>

<span class="w">  </span><span class="nv">ex</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">s</span><span class="o">∨</span><span class="w"> </span><span class="ni">𝕩</span><span class="o">∊</span><span class="ss">@</span><span class="o">+</span><span class="m">9</span><span class="p">‿</span><span class="m">10</span><span class="p">‿</span><span class="m">13</span><span class="p">‿</span><span class="m">32</span><span class="w">         </span><span class="c1"># Exclude whitespace and strings</span>
<span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">n</span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="w"> </span><span class="ni">𝕩</span><span class="o">∊</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="w">   </span><span class="c1"># Number beginnings</span>
<span class="w">  </span><span class="nv">nr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">•ParseFloat</span><span class="na">¨</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">nb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w"> </span><span class="c1"># Numbers to return</span>

<span class="w">  </span><span class="nv">ts</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">sb</span><span class="o">∨</span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="nv">nb</span><span class="o">∨</span><span class="ni">𝕩</span><span class="o">∊</span><span class="s2">&quot;[]&quot;</span><span class="w">        </span><span class="c1"># Tokens</span>
<span class="w">  </span><span class="p">⟨</span><span class="nv">ts</span><span class="o">/</span><span class="w"> </span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="o">/</span><span class="nv">nb</span><span class="sr">)</span><span class="py">⊸</span><span class="o">⊏</span><span class="sr">)</span><span class="w"> </span><span class="ni">𝕩</span><span class="p">,</span><span class="w"> </span><span class="nv">nr</span><span class="p">,</span><span class="w"> </span><span class="nv">sr</span><span class="p">⟩</span>
<span class="kt">}</span>
</pre></div>

<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Tokenise</span><span class="w"> </span><span class="s2">&quot;[1,&quot;&quot;a,2,b&quot;&quot;]&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[0&quot;&quot;]&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a,2,b&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">Tokenise</span><span class="w"> </span><span class="s2">&quot;[1,&quot;&quot;a&quot;&quot;,&quot;&quot;b_\\\&quot;&quot;\\_c&quot;&quot;,2]&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[0&quot;&quot;&quot;&quot;0]&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b_\\\&quot;&quot;\\_c&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
The parser doesn’t need to be adjusted at all this time and just works:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Parse</span><span class="w"> </span><span class="s2">&quot;[1,&quot;&quot;a&quot;&quot;,&quot;&quot;b_\\\&quot;&quot;\\_c&quot;&quot;,2]&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b_\\\&quot;&quot;\\_c&quot;</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">Parse</span><span class="w"> </span><span class="s2">&quot;[1,[2,[&quot;&quot;[x,10]&quot;&quot;,4]],5,[&quot;&quot;a&quot;&quot;,7],8]&quot;</span>
<span class="err">┌─</span>
<span class="m">·</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;[x,10]&quot;</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="m">8</span>
<span class="w">                                       </span><span class="err">┘</span>
</pre></div>

<h2 id="objects-and-their-ilk">Objects and their ilk<a href="#objects-and-their-ilk" class="floatleft sec-link">§</a></h2>
<p></p>
Onto the second big type we have to support: objects.
They should look like
<div class="highlight-text" style="padding-left: 1em;"><pre><span></span>{&quot;a&quot;: 1, &quot;b&quot;: [&quot;c&quot;, &quot;d&quot;]}
</pre></div>

<p></p>
and so on.
<p></p>
This time, lexing is the easy part—we merely have to add curly braces to our list of tokens.
Actually, to keep things visually comprehensible,
let’s go back on what I said at the beginning
and do the same for the comma as the array separator,
and the colon as the key–value separator.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="o">Tokenise</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">e</span><span class="w">  </span><span class="kd">←</span><span class="w"> </span><span class="o">»&lt;</span><span class="na">`</span><span class="s1">'\'</span><span class="o">=</span><span class="ni">𝕩</span><span class="w">                  </span><span class="c1"># Escapes</span>
<span class="w">  </span><span class="nv">sb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">s</span><span class="kd">←</span><span class="w"> </span><span class="o">≠</span><span class="na">`</span><span class="sr">(</span><span class="o">¬</span><span class="nv">e</span><span class="sr">)</span><span class="o">∧</span><span class="w"> </span><span class="s1">'&quot;'</span><span class="o">=</span><span class="ni">𝕩</span><span class="w">      </span><span class="c1"># String beginnings</span>
<span class="w">  </span><span class="nv">sr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="sr">(</span><span class="nv">s</span><span class="o">&gt;</span><span class="nv">sb</span><span class="sr">)</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w">        </span><span class="c1"># Strings to return</span>

<span class="w">  </span><span class="nv">ex</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">s</span><span class="o">∨</span><span class="w"> </span><span class="ni">𝕩</span><span class="o">∊</span><span class="ss">@</span><span class="o">+</span><span class="m">9</span><span class="p">‿</span><span class="m">10</span><span class="p">‿</span><span class="m">13</span><span class="p">‿</span><span class="m">32</span><span class="w">         </span><span class="c1"># Exclude whitespace and strings</span>
<span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">n</span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="w"> </span><span class="ni">𝕩</span><span class="o">∊</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="w">   </span><span class="c1"># Number beginnings</span>
<span class="w">  </span><span class="nv">nr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">•ParseFloat</span><span class="na">¨</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">nb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w"> </span><span class="c1"># Numbers to return</span>

<span class="w">  </span><span class="nv">ts</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">sb</span><span class="o">∨</span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="nv">nb</span><span class="o">∨</span><span class="ni">𝕩</span><span class="o">∊</span><span class="s2">&quot;[]{},:&quot;</span><span class="w">    </span><span class="c1"># Tokens</span>
<span class="c1">#                       ^^^^</span>
<span class="w">  </span><span class="p">⟨</span><span class="nv">ts</span><span class="o">/</span><span class="w"> </span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="o">/</span><span class="nv">nb</span><span class="sr">)</span><span class="py">⊸</span><span class="o">⊏</span><span class="sr">)</span><span class="w"> </span><span class="ni">𝕩</span><span class="p">,</span><span class="w"> </span><span class="nv">nr</span><span class="p">,</span><span class="w"> </span><span class="nv">sr</span><span class="p">⟩</span>
<span class="kt">}</span>
</pre></div>

<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Tokenise</span><span class="w"> </span><span class="s2">&quot;{&quot;&quot;a&quot;&quot;: 123, &quot;&quot;bcde&quot;&quot;: [1,&quot;&quot;42&quot;&quot;,30]}&quot;</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;{&quot;&quot;:0,&quot;&quot;:[0,&quot;&quot;,0]}&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">123</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;bcde&quot;</span><span class="w"> </span><span class="s2">&quot;42&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Looks good.
<h3 id="parsing-2">Parsing<a href="#parsing-2" class="floatleft sec-link">§</a></h3>
<p></p>
Since the parser will change quite a bit,
it is perhaps more instructive to build it up from scratch again.
Up to getting the depth, things don’t really change much.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">inp</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s2">&quot;{&quot;&quot;a&quot;&quot;: 1, &quot;&quot;b&quot;&quot;: [&quot;&quot;1&quot;&quot;,2,{&quot;&quot;a&quot;&quot;:2}]}&quot;</span>
<span class="s2">&quot;{&quot;&quot;a&quot;&quot;: 1, &quot;&quot;b&quot;&quot;: [&quot;&quot;1&quot;&quot;,2,{&quot;&quot;a&quot;&quot;:2}]}&quot;</span>
<span class="w">    </span><span class="nv">ts</span><span class="p">‿</span><span class="nv">nums</span><span class="p">‿</span><span class="nv">strs</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">Tokenise</span><span class="w"> </span><span class="nv">inp</span>
<span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;{&quot;&quot;:0,&quot;&quot;:[&quot;&quot;,0,{&quot;&quot;:0}]}&quot;</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">o</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">ts</span><span class="o">∊</span><span class="s2">&quot;{[&quot;</span><span class="w">  </span><span class="c1"># Open</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">c</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">ts</span><span class="o">∊</span><span class="s2">&quot;]}&quot;</span><span class="w">  </span><span class="c1"># Close</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">cl</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">':'</span><span class="o">=</span><span class="nv">ts</span><span class="w">  </span><span class="c1"># Colon</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">d</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋+</span><span class="na">`</span><span class="nv">o</span><span class="o">-</span><span class="nv">c</span><span class="w">   </span><span class="c1"># Depth</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">td</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">d</span><span class="o">⊏</span><span class="nv">ts</span><span class="w">    </span><span class="c1"># Tokens by depth</span>
<span class="s2">&quot;}{&quot;&quot;:0,&quot;&quot;:][&quot;&quot;,0,}{&quot;&quot;:0&quot;</span>
</pre></div>

<p></p>
Since we now have two different “container” types,
we also need to be careful about how “nesting” is defined—<!--
-->sometimes we may only want the delimiters of one container to increase the level of nesting.
Let’s start with getting a mask of the start of all new sublists<!--
--><label for="sn-8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-8" class="margin-toggle" /><div class="sidenote">I will use this as shorthand for “sub-object and sub-array”.
Not the best terminology, I suppose, but it will have to do.</div><!--
-->,
which are now defined by an opening brace or bracket:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">s</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">td</span><span class="o">∊</span><span class="s2">&quot;[{&quot;</span><span class="w">  </span><span class="c1"># Sublist starts</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">td</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">s</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;}{':0,':][',0,}{':0</span>
<span class="s2">  0100000001000001000&quot;</span>
<span class="w">                      </span><span class="err">┘</span>
</pre></div>

<p></p>
We also did the same thing in the original parser
when we defined the sublist depth <code>l ← (⍋d)⊏+`'['=d⊏ts</code>,
only we didn’t give <code>'['=d⊏ts</code>
(which now morphed to <code>(d⊏ts)∊"[{"</code> due to the additional container types) a name.
However, defining the sublist depth still works as before:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">n</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="nv">s</span><span class="w">  </span><span class="c1"># Nesting</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">n</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;{':0,':[',0,{':0}]}</span>
<span class="s2">  1111111222223333210&quot;</span>
<span class="w">                      </span><span class="err">┘</span>
</pre></div>

<p></p>
Moving on, we can use the mask of sublists <code>s</code> to build a mask of sub-objects.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">s</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">td</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">s</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;}{':0,':][',0,}{':0</span>
<span class="s2">  0100000001000001000&quot;</span>
<span class="w">                      </span><span class="err">┘</span>
<span class="w">    </span><span class="nv">of</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">s</span><span class="o">/</span><span class="s1">'{'</span><span class="o">=</span><span class="nv">td</span><span class="w">  </span><span class="c1"># Filter of sublists that are objects</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
The <code>of</code> variable is to be read as something like “there are three sublists, the first and third of which are sub-objects”.
This is good, but doesn’t yet take object nesting into account<!--
-->—the second <code>1</code> in <code>of</code>,
being nested inside of the first object,
is actually at depth two and should be treated accordingly.
To fix this, we proceed as before and do a sum <a href="https://mlochbaum.github.io/BQN/doc/scan.html">scan</a> across <code>of</code>,
with a subsequent stencil to make sure we only select the objects.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">+</span><span class="na">`</span><span class="nv">of</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">on</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="o">×</span><span class="w"> </span><span class="o">+</span><span class="na">`</span><span class="nv">of</span><span class="w">  </span><span class="c1"># Object nesting</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">on</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">+</span><span class="na">`</span><span class="py">⊸</span><span class="o">×</span><span class="w"> </span><span class="nv">of</span><span class="w">    </span><span class="c1"># Object nesting (prettier!)</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Next, let’s get the keys of each object and <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a> them by depth,
as this will make subsequent processing much easier.
That is, given an input like <code>{"a": 1, "b": [1, "c", {"a": 2}]}</code>,
we want to end up with <code>⟨⟨"a", "b"⟩, ⟨"a"⟩⟩</code>.
Actually, since strings can be values as well,
we probably want to separate those, too,
ending up with an array of the form <code>⟨⟨"c"⟩, ⟨"a", "b"⟩, ⟨"a"⟩⟩</code>.
<p></p>
Selecting the keys themselves is easy:
just go to the colons, <a href="https://mlochbaum.github.io/BQN/doc/shift.html">nudge</a> them to consider the token before, and <a href="https://mlochbaum.github.io/BQN/doc/select.html">select</a> from all strings.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">cl</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="o">«</span><span class="nv">cl</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;{':0,':[',0,{':0}]}</span>
<span class="s2">  0100010000000100000&quot;</span>
<span class="w">                      </span><span class="err">┘</span>
<span class="w">    </span><span class="sr">(</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">ts</span><span class="sr">)</span><span class="o">/«</span><span class="nv">cl</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
A <code>0</code> stands for “this string is a value”,
and a <code>1</code> is for “this string is a key somewhere”.
We already have a nesting variable <code>n</code>,
which however also increases the depth when hitting an array instead of an object.
If we had one only for objects, we could use that as a stencil to obtain a depth ordered list when combining it with the above.
<p></p>
There’s (at least) two things we can do:
re-create <code>n</code> but only take into consideration objects,
or somehow use <code>n</code>, but punch holes into it for the arrays.
The first way is straightforward and essentially just copies the definition of <code>n</code>:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="nv">td</span><span class="o">=</span><span class="s1">'{'</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="nv">td</span><span class="o">=</span><span class="s1">'{'</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;{':0,':[',0,{':0}]}</span>
<span class="s2">  1111111111112222110&quot;</span>
<span class="w">                      </span><span class="err">┘</span>
<span class="w">    </span><span class="sr">(</span><span class="o">«</span><span class="nv">cl</span><span class="sr">)</span><span class="o">×</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="nv">td</span><span class="o">=</span><span class="s1">'{'</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">(</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">ts</span><span class="sr">)</span><span class="o">/</span><span class="w"> </span><span class="sr">(</span><span class="o">«</span><span class="nv">cl</span><span class="sr">)</span><span class="o">×</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="nv">td</span><span class="o">=</span><span class="s1">'{'</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
However, this seems quite inelegant to me;
thankfully, punching holes into <code>n</code> is not as hard as it sounds.
We already have an array <code>on</code> that tells us about the object nesting,
with a <code>0</code> standing in for “this is the start of an array”.
That means if we simply use <code>n</code> to <a href="https://mlochbaum.github.io/BQN/doc/select.html">select</a> from <code>on</code>,
this gives us what we want!<!--
--><label for="sn-9" class="margin-toggle">⊕</label><input type="checkbox" id="sn-9" class="margin-toggle" /><div class="marginnote">󠀠
<p></p>
󠀠
<p></p>
Don’t worry too much about having to use <code>0∾on</code> instead of <code>on</code> here;
this appears because we are starting at depth zero before reading anything.
Assuming well-formed <span class="small-caps">json</span>, this will appear only once at the very end.</div><!--
-->
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">n</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;{':0,':[',0,{':0}]}</span>
<span class="s2">  1111111222223333210&quot;</span>
<span class="w">                      </span><span class="err">┘</span>
<span class="w">    </span><span class="nv">n</span><span class="o">⊏</span><span class="m">0</span><span class="o">∾</span><span class="nv">on</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">ts</span><span class="w"> </span><span class="o">DP</span><span class="w"> </span><span class="nv">n</span><span class="o">⊏</span><span class="m">0</span><span class="o">∾</span><span class="nv">on</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="s2">&quot;{':0,':[',0,{':0}]}</span>
<span class="s2">  1111111000002222010&quot;</span>
<span class="w">                      </span><span class="err">┘</span>
<span class="w">    </span><span class="sr">(</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">ts</span><span class="sr">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="sr">(</span><span class="o">«</span><span class="nv">cl</span><span class="sr">)</span><span class="o">×</span><span class="nv">n</span><span class="o">⊏</span><span class="m">0</span><span class="o">∾</span><span class="nv">on</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
All that’s left is to <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a> the given strings!
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="sr">((</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">ts</span><span class="sr">)</span><span class="o">/</span><span class="sr">(</span><span class="o">«</span><span class="nv">cl</span><span class="sr">)</span><span class="o">×</span><span class="nv">n</span><span class="o">⊏</span><span class="m">0</span><span class="o">∾</span><span class="nv">on</span><span class="sr">)</span><span class="w"> </span><span class="o">⊔</span><span class="w"> </span><span class="nv">strs</span><span class="w">         </span><span class="c1"># Keys</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="sr">((</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">ts</span><span class="sr">)</span><span class="o">/</span><span class="sr">(</span><span class="o">«</span><span class="nv">cl</span><span class="sr">)</span><span class="o">×</span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="nv">td</span><span class="o">=</span><span class="s1">'{'</span><span class="sr">)</span><span class="w"> </span><span class="o">⊔</span><span class="w"> </span><span class="nv">strs</span><span class="w">  </span><span class="c1"># Same result</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
There is but a small wrinkle yet to fix:
if the object is empty, it might be that
<code>(('"'=ts)/(«cl)×(⍋d)⊏+`td='{')</code> returns a nonsense answer,
which would yield an error when trying to <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a> the strings.
This is much the same situation as before when we had to change <code>1-˜ln/l</code> to <code>(+´c)∾˜1-˜ln/l</code> during the construction of the final array.
The fix here is similar, since with <code>of</code> we have an obvious quantity, the <a href="https://mlochbaum.github.io/BQN/doc/shape.html">length</a> of which is always the length we want to end up with,<!--
--><label for="sn-10" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-10" class="margin-toggle" /><div class="sidenote">Remember that questionable <a href="https://mlochbaum.github.io/BQN/doc/group.html">group</a> <span class="small-caps">api</span>?</div><!--
-->
even when trying to parse <code>{}</code>.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">ks</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">((</span><span class="m">1</span><span class="o">+</span><span class="na">´</span><span class="nv">of</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="w"> </span><span class="sr">(</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">ts</span><span class="sr">)</span><span class="o">/</span><span class="sr">(</span><span class="o">«</span><span class="nv">cl</span><span class="sr">)</span><span class="o">×</span><span class="nv">n</span><span class="o">⊏</span><span class="m">0</span><span class="o">∾</span><span class="nv">on</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">strs</span><span class="w"> </span><span class="c1"># Keys, final definition</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Building up our initial list of values,
this now includes all numbers, as well as all strings that are not keys.
Conveniently, by the above argument the latter is exactly the first element of <code>ks</code>.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">vs</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">nums</span><span class="w"> </span><span class="o">∾</span><span class="w"> </span><span class="o">⊑</span><span class="nv">ks</span><span class="w"> </span><span class="c1"># Initial values</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Building up the value indices works exactly the same as before;
the only complication now is that a definition of <code>ln ← ts∊"""0]"</code> for literals and nesting does not work anymore, as we need to exclude the strings that are keys.
What seems to work best is to specify what <code>ln</code> should <em>not</em> be:
a comma, a colon, any opening parenthesis, and its token should not occur immediately before a colon.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">ln</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">¬</span><span class="w"> </span><span class="sr">(</span><span class="o">«</span><span class="py">⊸</span><span class="o">∨</span><span class="nv">cl</span><span class="sr">)</span><span class="o">∨</span><span class="nv">o</span><span class="o">∨</span><span class="s1">','</span><span class="o">=</span><span class="nv">ts</span><span class="w">                       </span><span class="c1"># Literals and nesting</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">vi</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋⍋</span><span class="w"> </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'0'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sr">(</span><span class="m">2</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'&quot;'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">c</span><span class="w">  </span><span class="c1"># Value indices</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">vi</span><span class="w"> </span><span class="o">⊏</span><span class="kd">↩</span><span class="w"> </span><span class="sr">(</span><span class="o">↕≠</span><span class="nv">vs</span><span class="sr">)</span><span class="o">∾</span><span class="sr">(</span><span class="o">≠</span><span class="nv">vs</span><span class="sr">)</span><span class="o">+</span><span class="w"> </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">n</span><span class="w">                  </span><span class="c1"># Fix value indices</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">⟩</span>
</pre></div>

<p></p>
Almost done—the only thing left is to build up the finished, nested, array.
This is also the time we have to decide upon the final representation of an object.
What turns out to be quite convenient for small-ish <span class="small-caps">json</span><!--
-->—which, let’s be honest, will be the only kind of <span class="small-caps">json</span> that <code>Parse</code> ever gets to see—<!--
-->is to use <a href="https://mlochbaum.github.io/BQN/doc/rank.html">rank</a> 2 arrays;
an object <code>{"a": 1}</code> gets parsed into <code>2‿1⥊"a"‿1</code>.
Further, when building the result we have to make sure to “recognise” when to pull values and sublists out of the recursively build up <code>vs</code>,
and when to use <code>ks</code> to get keys instead.
This can be achieved by taking <code>on</code> into consideration
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">⌽</span><span class="sr">((</span><span class="o">≠</span><span class="nv">on</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">n</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span><span class="w">  </span><span class="c1"># How to build which sublist</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">⌽</span><span class="nv">on</span><span class="w">                   </span><span class="c1"># Which sublist is an object?</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">on</span><span class="w"> </span><span class="o">≍</span><span class="py">○</span><span class="o">⌽</span><span class="w"> </span><span class="sr">((</span><span class="o">≠</span><span class="nv">on</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">n</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="w"> </span><span class="m">2</span><span class="w">     </span><span class="m">0</span><span class="w">         </span><span class="m">1</span>
<span class="w">  </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">                         </span><span class="err">┘</span>
</pre></div>

<p></p>
This means that the final shape is something like
<code>on BUILD¨○⌽ ((≠on)∾˜1-˜ln/l)⊔vi</code>,
where <code>BUILD</code> is a dyadic function,
taking as its left argument a number that’s zero if we are dealing with a list or literal,
and bigger than zero if we have an object and want to select at least one key.
The right argument first <a href="https://mlochbaum.github.io/BQN/doc/select.html">select</a>s the required sublist or value from <code>vs</code>,
and then refines this selection by picking possible keys out of <code>ks</code>.
Putting this into code:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">on</span><span class="w"> </span><span class="kt">{</span><span class="nv">vs</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="ni">𝕨</span><span class="o">Sel</span><span class="ni">𝕩</span><span class="o">⊏</span><span class="nv">vs</span><span class="w"> </span><span class="p">⋄</span><span class="ss">@</span><span class="kt">}</span><span class="na">¨</span><span class="py">○</span><span class="o">⌽</span><span class="w"> </span><span class="sr">((</span><span class="o">≠</span><span class="nv">on</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">l</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span><span class="w"> </span><span class="c1"># Build result</span>
</pre></div>

<p></p>
All that’s left to do is to write <code>Sel</code>.
Doing nothing when <code>𝕨</code> is zero can just be achieved with a
<a href="https://mlochbaum.github.io/BQN/doc/block.html#block-headers">header</a>.
If <code>𝕨</code> is a number, it represents the depth of the object, and directly corresponds with the indexing of <code>ks</code>,
so we can just <a href="https://mlochbaum.github.io/BQN/doc/pick.html">pick</a> the result and <a href="https://mlochbaum.github.io/BQN/doc/couple.html">couple</a> it to <code>𝕩</code> to make things a <a href="https://mlochbaum.github.io/BQN/doc/rank.html">rank</a> 2 array.<!--
--><label for="sn-11" class="margin-toggle">⊕</label><input type="checkbox" id="sn-11" class="margin-toggle" /><div class="marginnote">󠀠
<p></p>
I find this process of treating values and keys separately,
but in a way that they eventually match up at the end,
almost magical.</div><!--
-->
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="o">Sel</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span><span class="m">0</span><span class="o">𝕊</span><span class="nv">x</span><span class="ni">:</span><span class="w"> </span><span class="nv">x</span><span class="ni">;</span><span class="w"> </span><span class="nv">i</span><span class="o">𝕊</span><span class="nv">x</span><span class="ni">:</span><span class="w"> </span><span class="sr">(</span><span class="nv">i</span><span class="o">⊑</span><span class="nv">ks</span><span class="sr">)</span><span class="o">≍</span><span class="nv">x</span><span class="kt">}</span><span class="w">  </span><span class="c1"># Select</span>
<span class="sr">(</span><span class="nv">function</span><span class="w"> </span><span class="nv">block</span><span class="sr">)</span>
<span class="w">    </span><span class="o">Sel</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⊑</span><span class="py">⟜</span><span class="nv">ks</span><span class="py">⊸</span><span class="o">≍</span><span class="py">⍟</span><span class="sr">(</span><span class="m">0</span><span class="o">&lt;⊣</span><span class="sr">)</span><span class="w">             </span><span class="c1"># Point-free and without blocks</span>
<span class="o">⊑</span><span class="py">⟜</span><span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span><span class="py">⊸</span><span class="o">≍</span><span class="py">⍟</span><span class="sr">(</span><span class="m">0</span><span class="o">&lt;⊣</span><span class="sr">)</span>

<span class="c1"># The object {&quot;a&quot;: 2} is the first non-literal that's constructed.</span>
<span class="w">    </span><span class="nv">inp</span>
<span class="s2">&quot;{&quot;&quot;a&quot;&quot;: 1, &quot;&quot;b&quot;&quot;: [&quot;&quot;1&quot;&quot;,2,{&quot;&quot;a&quot;&quot;:2}]}&quot;</span>
<span class="w">    </span><span class="o">⌽</span><span class="sr">((</span><span class="o">≠</span><span class="nv">on</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">n</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span>
<span class="p">⟨</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟨</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="p">⟩</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="o">⌽</span><span class="nv">on</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="nv">vs</span>
<span class="p">⟨</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="p">⟩</span>
<span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="o">Sel</span><span class="w"> </span><span class="p">⟨</span><span class="m">2</span><span class="p">⟩</span><span class="o">⊏</span><span class="nv">vs</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="w"> </span><span class="s2">&quot;a&quot;</span>
<span class="w">   </span><span class="m">2</span>
<span class="w">      </span><span class="err">┘</span>
</pre></div>

<p></p>
And that’s pretty much it—here are the last two lines, in all their glory:
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="w">    </span><span class="nv">on</span><span class="w"> </span><span class="kt">{</span><span class="nv">vs</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="ni">𝕨</span><span class="o">Sel</span><span class="ni">𝕩</span><span class="o">⊏</span><span class="nv">vs</span><span class="w"> </span><span class="p">⋄</span><span class="ss">@</span><span class="kt">}</span><span class="na">¨</span><span class="py">○</span><span class="o">⌽</span><span class="w"> </span><span class="sr">((</span><span class="o">≠</span><span class="nv">on</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">n</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span><span class="w">  </span><span class="c1"># Build result</span>
<span class="s2">&quot;   &quot;</span>
<span class="w">    </span><span class="m">¯1</span><span class="o">⊑</span><span class="nv">vs</span><span class="w">                                           </span><span class="c1"># Get result</span>
<span class="err">┌─</span>
<span class="err">╵</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="w"> </span><span class="s2">&quot;b&quot;</span>
<span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="err">┌─</span>
<span class="w">       </span><span class="m">·</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="err">┌─</span>
<span class="w">               </span><span class="err">╵</span><span class="w"> </span><span class="s2">&quot;a&quot;</span>
<span class="w">                  </span><span class="m">2</span>
<span class="w">                     </span><span class="err">┘</span>
<span class="w">                       </span><span class="err">┘</span>
<span class="w">                         </span><span class="err">┘</span>
<span class="w">    </span><span class="nv">inp</span>
<span class="s2">&quot;{&quot;&quot;a&quot;&quot;: 1, &quot;&quot;b&quot;&quot;: [&quot;&quot;1&quot;&quot;,2,{&quot;&quot;a&quot;&quot;:2}]}&quot;</span>
</pre></div>

<p></p>
It works!
<hr />
<p></p>
At the risk of repeating myself, let’s look at the entire parser as well as the tokeniser that we’ve built over the course of this post.
<div class="highlight-bqn" style="padding-left: 1em;"><pre><span></span><span class="o">Tokenise</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">e</span><span class="w">  </span><span class="kd">←</span><span class="w"> </span><span class="o">»&lt;</span><span class="na">`</span><span class="s1">'\'</span><span class="o">=</span><span class="ni">𝕩</span><span class="w">                  </span><span class="c1"># Escapes</span>
<span class="w">  </span><span class="nv">sb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">s</span><span class="kd">←</span><span class="w"> </span><span class="o">≠</span><span class="na">`</span><span class="sr">(</span><span class="o">¬</span><span class="nv">e</span><span class="sr">)</span><span class="o">∧</span><span class="w"> </span><span class="s1">'&quot;'</span><span class="o">=</span><span class="ni">𝕩</span><span class="w">      </span><span class="c1"># String beginnings</span>
<span class="w">  </span><span class="nv">sr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="sr">(</span><span class="nv">s</span><span class="o">&gt;</span><span class="nv">sb</span><span class="sr">)</span><span class="o">×+</span><span class="na">`</span><span class="nv">sb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w">        </span><span class="c1"># Strings to return</span>

<span class="w">  </span><span class="nv">ex</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">s</span><span class="o">∨</span><span class="w"> </span><span class="ni">𝕩</span><span class="o">∊</span><span class="ss">@</span><span class="o">+</span><span class="m">9</span><span class="p">‿</span><span class="m">10</span><span class="p">‿</span><span class="m">13</span><span class="p">‿</span><span class="m">32</span><span class="w">         </span><span class="c1"># Exclude whitespace and strings</span>
<span class="w">  </span><span class="nv">nb</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">»</span><span class="py">⊸</span><span class="o">&lt;</span><span class="w"> </span><span class="nv">n</span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="w"> </span><span class="ni">𝕩</span><span class="o">∊</span><span class="s1">'0'</span><span class="o">+↕</span><span class="m">10</span><span class="w">   </span><span class="c1"># Number beginnings</span>
<span class="w">  </span><span class="nv">nr</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">•ParseFloat</span><span class="na">¨</span><span class="sr">(</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">n</span><span class="o">×+</span><span class="na">`</span><span class="nv">nb</span><span class="sr">)</span><span class="o">⊔</span><span class="ni">𝕩</span><span class="w"> </span><span class="c1"># Numbers to return</span>

<span class="w">  </span><span class="nv">ts</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">sb</span><span class="o">∨</span><span class="sr">(</span><span class="o">¬</span><span class="nv">ex</span><span class="sr">)</span><span class="o">∧</span><span class="nv">nb</span><span class="o">∨</span><span class="ni">𝕩</span><span class="o">∊</span><span class="s2">&quot;[]{},:&quot;</span><span class="w">    </span><span class="c1"># Tokens</span>
<span class="w">  </span><span class="p">⟨</span><span class="nv">ts</span><span class="o">/</span><span class="w"> </span><span class="s1">'0'</span><span class="na">¨</span><span class="py">⌾</span><span class="sr">((</span><span class="o">/</span><span class="nv">nb</span><span class="sr">)</span><span class="py">⊸</span><span class="o">⊏</span><span class="sr">)</span><span class="w"> </span><span class="ni">𝕩</span><span class="p">,</span><span class="w"> </span><span class="nv">nr</span><span class="p">,</span><span class="w"> </span><span class="nv">sr</span><span class="p">⟩</span>
<span class="kt">}</span>

<span class="o">Parse</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span>
<span class="w">  </span><span class="nv">ts</span><span class="p">‿</span><span class="nv">nums</span><span class="p">‿</span><span class="nv">strs</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">Tokenise</span><span class="w"> </span><span class="ni">𝕩</span>
<span class="w">  </span><span class="nv">d</span><span class="w">  </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋+</span><span class="na">`</span><span class="sr">(</span><span class="nv">o</span><span class="kd">←</span><span class="nv">ts</span><span class="o">∊</span><span class="s2">&quot;{[&quot;</span><span class="sr">)</span><span class="o">-</span><span class="sr">(</span><span class="nv">c</span><span class="kd">←</span><span class="nv">ts</span><span class="o">∊</span><span class="s2">&quot;]}&quot;</span><span class="sr">)</span><span class="w"> </span><span class="c1"># Closing, opening, depth</span>
<span class="w">  </span><span class="nv">td</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">d</span><span class="o">⊏</span><span class="nv">ts</span><span class="w">                       </span><span class="c1"># Tokens by depth</span>
<span class="w">  </span><span class="nv">s</span><span class="w">  </span><span class="kd">←</span><span class="w"> </span><span class="nv">td</span><span class="o">∊</span><span class="s2">&quot;[{&quot;</span><span class="w">                    </span><span class="c1"># Sublist starts</span>
<span class="w">  </span><span class="nv">n</span><span class="w">  </span><span class="kd">←</span><span class="w"> </span><span class="sr">(</span><span class="o">⍋</span><span class="nv">d</span><span class="sr">)</span><span class="o">⊏+</span><span class="na">`</span><span class="nv">s</span><span class="w">                   </span><span class="c1"># Nesting</span>

<span class="w">  </span><span class="nv">of</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">s</span><span class="o">/</span><span class="s1">'{'</span><span class="o">=</span><span class="nv">td</span><span class="w">                   </span><span class="c1"># Filter of subsists that are objects</span>
<span class="w">  </span><span class="nv">on</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">+</span><span class="na">`</span><span class="py">⊸</span><span class="o">×</span><span class="w"> </span><span class="nv">of</span><span class="w">                    </span><span class="c1"># Object nesting</span>
<span class="w">  </span><span class="nv">cl</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="s1">':'</span><span class="o">=</span><span class="nv">ts</span><span class="w">                     </span><span class="c1"># Colon</span>
<span class="w">  </span><span class="nv">ks</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="sr">((</span><span class="m">1</span><span class="o">+</span><span class="na">´</span><span class="nv">of</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="w"> </span><span class="sr">(</span><span class="s1">'&quot;'</span><span class="o">=</span><span class="nv">ts</span><span class="sr">)</span><span class="o">/</span><span class="sr">(</span><span class="o">«</span><span class="nv">cl</span><span class="sr">)</span><span class="o">×</span><span class="nv">n</span><span class="o">⊏</span><span class="m">0</span><span class="o">∾</span><span class="nv">on</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">strs</span><span class="w">    </span><span class="c1"># Keys</span>

<span class="w">  </span><span class="nv">vs</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="nv">nums</span><span class="w"> </span><span class="o">∾</span><span class="w"> </span><span class="o">⊑</span><span class="nv">ks</span><span class="w">                 </span><span class="c1"># Initial values</span>
<span class="w">  </span><span class="nv">ln</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">¬</span><span class="w"> </span><span class="sr">(</span><span class="o">«</span><span class="py">⊸</span><span class="o">∨</span><span class="nv">cl</span><span class="sr">)</span><span class="o">∨</span><span class="nv">o</span><span class="o">∨</span><span class="s1">','</span><span class="o">=</span><span class="nv">ts</span><span class="w">         </span><span class="c1"># Literals and nesting</span>
<span class="w">  </span><span class="nv">vi</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="o">⍋⍋</span><span class="w"> </span><span class="sr">(</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'0'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sr">(</span><span class="m">2</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">ts</span><span class="o">=</span><span class="s1">'&quot;'</span><span class="sr">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="o">×</span><span class="nv">ln</span><span class="o">/</span><span class="nv">c</span><span class="w">   </span><span class="c1"># Value indices</span>
<span class="w">  </span><span class="nv">vi</span><span class="w"> </span><span class="o">⊏</span><span class="kd">↩</span><span class="w"> </span><span class="sr">(</span><span class="o">↕≠</span><span class="nv">vs</span><span class="sr">)</span><span class="o">∾</span><span class="sr">(</span><span class="o">≠</span><span class="nv">vs</span><span class="sr">)</span><span class="o">+</span><span class="w"> </span><span class="o">≠</span><span class="py">⊸</span><span class="o">-</span><span class="w"> </span><span class="nv">c</span><span class="o">/»</span><span class="nv">n</span><span class="w">                   </span><span class="c1"># Fix value indices</span>

<span class="w">  </span><span class="o">Sel</span><span class="w"> </span><span class="kd">←</span><span class="w"> </span><span class="kt">{</span><span class="sr">(</span><span class="ni">𝕨</span><span class="o">⊑</span><span class="nv">ks</span><span class="sr">)</span><span class="o">≍</span><span class="ni">𝕩</span><span class="kt">}</span><span class="py">⍟</span><span class="sr">(</span><span class="m">0</span><span class="o">&lt;⊣</span><span class="sr">)</span><span class="w">          </span><span class="c1"># Select</span>
<span class="w">  </span><span class="nv">on</span><span class="w"> </span><span class="kt">{</span><span class="nv">vs</span><span class="w"> </span><span class="o">∾</span><span class="kd">↩</span><span class="w"> </span><span class="o">&lt;</span><span class="ni">𝕨</span><span class="o">Sel</span><span class="ni">𝕩</span><span class="o">⊏</span><span class="nv">vs</span><span class="w"> </span><span class="p">⋄</span><span class="ss">@</span><span class="kt">}</span><span class="na">¨</span><span class="py">○</span><span class="o">⌽</span><span class="w"> </span><span class="sr">((</span><span class="o">≠</span><span class="nv">on</span><span class="sr">)</span><span class="o">∾</span><span class="na">˜</span><span class="m">1</span><span class="o">-</span><span class="na">˜</span><span class="nv">ln</span><span class="o">/</span><span class="nv">n</span><span class="sr">)</span><span class="o">⊔</span><span class="nv">vi</span><span class="w"> </span><span class="c1"># Build result</span>
<span class="w">  </span><span class="m">¯1</span><span class="o">⊑</span><span class="nv">vs</span>
<span class="kt">}</span>
</pre></div>

<p></p>
I don’t know about you,
but I think it’s pretty incredible that one can write a parser for a reasonable subset<!--
--><label for="sn-12" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-12" class="margin-toggle" /><div class="sidenote">With a simple extension to the tokeniser to recognise the constants <code>true</code>, <code>false</code>, and <code>null</code>,
this already parses the <code>cargo metadata</code> output of a few Rust crates that I’ve tried,
which is the sort of data I would characterise as “ordinary <span class="small-caps">json</span>”.
The resulting representation is probably not super easy to work with<!--
  -->—there’s quite a lot of metadata and thus the nesting gets quite deep—<!--
  -->but still, it works.</div><!--
--> of <span class="small-caps">json</span>,
using what are essentially only flat arrays of numbers,
and still have it be this compact.
<h2 id="conclusion">Conclusion<a href="#conclusion" class="floatleft sec-link">§</a></h2>
<p></p>
I can probably offer the same conclusion as in the
<a href="https://tony-zorman.com/posts/bqn-csv.html" class="local-link"><span class="small-caps">csv</span> post</a>:
<blockquote>
<p></p>
Q: Is writing (and reading) a parser in an array language unnecessarily hard?<br />
A: Yes.
<p></p>
Q: Is it the most fun I’ve had programming in a long time?<br />
A: Yes.
</blockquote>
<p></p>
There’s really something to be said about this style of writing parsers.
I hope I’m not butchering this,
but I believe that Marshall Lochbaum<!--
-->—the creator of <span class="small-caps">bqn</span>—<!--
-->once said that it is
hard to write,
hard to read,
hard to modify,
but an absolute joy to debug,
and I would have to agree on all points.
Especially the debugging part, though:
since there’s essentially no branching, control flow is trivial,
and furthermore everything is just a flat array of numbers.
Once that one <code>0</code> that should be a <code>1</code> is identified, going back to the source just involves reading backwards, with no logic to keep track of at all.
<p></p>
Interestingly, this feels quite different from ordinary array programming—<!--
-->especially the quite tricky task to give lots of names<!--
--><label for="sn-13" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-13" class="margin-toggle" /><div class="sidenote">Short names at that, otherwise things just look too cumbersome in this style of programming.</div><!--
--> to lots of concepts.
Still, I suppose this is much more readable than if one tried to make the names go away by using combinators.
At least there are comments, right?
<p></p>
I certainly wouldn’t write all—or even most—parsers in this style,
but honestly this whole thing was so refreshing that I can’t help but recommend anyone to try at least getting the hang of a simplified form of one of the parsing libraries in <a href="https://github.com/mlochbaum/bqn-libs">bqn-libs</a>.
</div>

      <!-- Body is included in the above file -->
    </section>
    
      <!-- A footer-ish thing above the actual boring footer for pretty
           fleurons and things that should only appear on posts. -->
      <div style="text-align:center;">
        <img class="fleuron-block" src="../images/fleuron.svg" style="max-width: 3cm" alt="End of post fleuron">
        Have a comment? Write me an <a href="../about.html">email!</a>
      </div>
    
</article>


      </div>
      <div id="footer">
        <!-- Left -->
        <a id="to-top" href="#">top</a>
        <!-- Right -->
        <a href="../atom.xml" style="font-variant:small-caps">rss</a>
        &nbsp;|&nbsp;
        <a href="https://github.com/slotThe/slotThe.github.io">Website source</a>
        &nbsp;|&nbsp;
        <a href="../impressum.html">Legal notice and privacy policy</a>
      </div>
    </div>
  </body>
</html>
